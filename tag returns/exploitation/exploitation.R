#--------------------------------------------------------------
#Ben Neely
#11/27/2023
#Estimate exploitation by size category at each impoundment
#--------------------------------------------------------------

## Clear R
cat("\014")  
rm(list=ls())

## Install and load packages
## Checks if package is installed, installs if not, activates for current session
if("FSA" %in% rownames(installed.packages()) == FALSE) {install.packages("FSA")}
library(FSA)

if("rio" %in% rownames(installed.packages()) == FALSE) {install.packages("rio")}
library(rio)

if("patchwork" %in% rownames(installed.packages()) == FALSE) {install.packages("patchwork")}
library(patchwork)

if("tidyverse" %in% rownames(installed.packages()) == FALSE) {install.packages("tidyverse")}
library(tidyverse)

## Set ggplot theme
pubtheme=theme_classic()+
  theme(panel.grid=element_blank(), 
        panel.background=element_blank(),
        plot.background=element_blank(),
        panel.border=element_rect(fill="transparent"),
        axis.title=element_text(size=18,color="black",face="bold"),
        axis.text=element_text(size=14,color="black"),
        legend.position=c(0.999,0.999),
        legend.justification=c("right","top"),
        legend.title=element_blank(),
        legend.text=element_text(size=12),
        legend.background=element_blank(),
        plot.margin=margin(0,0,0,0,"pt"))
options(scipen=999)

## Set working directory
setwd("C:/Users/Ben.Neely/OneDrive - State of Kansas, OITS/Desktop/BCF pop character paper/tag returns/exploitation")

## Read in data with import
returndat=import("one_year_return_exp.csv")%>%
  rename(impd=impd.tagged)%>%
  filter(tl>=300,
         inbasin==1)%>%
  mutate(SQ=case_when(tl>=300 & tl<510 ~ 1, TRUE ~ 0),
         QP=case_when(tl>=510 & tl<760 ~ 1, TRUE ~ 0),
         PM=case_when(tl>=760 & tl<890 ~ 1, TRUE ~ 0),
         M=case_when(tl>=890 ~ 1, TRUE ~ 0))

taggeddat=import("tagged_fish_exp.csv")%>%
  filter(tl>=300)%>%
  mutate(SQ=case_when(tl>=300 & tl<510 ~ 1, TRUE ~ 0),
         QP=case_when(tl>=510 & tl<760 ~ 1, TRUE ~ 0),
         PM=case_when(tl>=760 & tl<890 ~ 1, TRUE ~ 0),
         M=case_when(tl>=890 ~ 1, TRUE ~ 0))

################################################################################
################################################################################
## Milford
milr_ret=returndat%>%
  filter(impd=="MILR")

milr_harv=returndat%>%
  filter(impd=="MILR" & hr=="Harvest")

milr_tag=taggeddat%>%
  filter(impd=="MILR")

## Identify number of fish returned in each size group
milr_under_ret=nrow(subset(milr_ret,nuwo=="under"))
milr_within_ret=nrow(subset(milr_ret,nuwo=="within"))
milr_over_ret=nrow(subset(milr_ret,nuwo=="over"))

## Identify number of fish harvested in each size group
milr_under_harv=nrow(subset(milr_ret,nuwo=="under" & hr=="Harvest"))
milr_within_harv=nrow(subset(milr_ret,nuwo=="within" & hr=="Harvest"))
milr_over_harv=nrow(subset(milr_ret,nuwo=="over" & hr=="Harvest"))

## Identify number of fish tagged in each size group
milr_under_tagged=nrow(subset(milr_tag,nuwo=="under"))
milr_within_tagged=nrow(subset(milr_tag,nuwo=="within"))
milr_over_tagged=nrow(subset(milr_tag,nuwo=="over"))

## Identify number of harvest-susceptible tagged fish
milr_suscep=nrow(subset(milr_tag,nuwo != "within"))

## State annual tag reporting rate and tag loss
milr_rr_min=0.75
milr_rr_med=0.50
milr_rr_max=0.25
milr_tl=0.30

###############################################################################
## Catch rates, pages 554-556 in Fisheries Techniques 3rd edition
## Under
milr_under_catch_min=milr_under_ret/(milr_under_tagged*(1-milr_tl)*milr_rr_min)
milr_under_catch_med=milr_under_ret/(milr_under_tagged*(1-milr_tl)*milr_rr_med)
milr_under_catch_max=milr_under_ret/(milr_under_tagged*(1-milr_tl)*milr_rr_max)

## Within
milr_within_catch_min=milr_within_ret/(milr_within_tagged*(1-milr_tl)*milr_rr_min)
milr_within_catch_med=milr_within_ret/(milr_within_tagged*(1-milr_tl)*milr_rr_med)
milr_within_catch_max=milr_within_ret/(milr_within_tagged*(1-milr_tl)*milr_rr_max)

## Over
milr_over_catch_min=milr_over_ret/(milr_over_tagged*(1-milr_tl)*milr_rr_min)
milr_over_catch_med=milr_over_ret/(milr_over_tagged*(1-milr_tl)*milr_rr_med)
milr_over_catch_max=milr_over_ret/(milr_over_tagged*(1-milr_tl)*milr_rr_max)

## Total
milr_tot_catch_min=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_min)
milr_tot_catch_med=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_med)
milr_tot_catch_max=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_max)

milr_catch_out=bind_cols(c("milr","milr","milr","milr"),
                        c("catch","catch","catch","catch"),
                        c("under","within","over","total"),
                        c(milr_under_catch_min,milr_within_catch_min,milr_over_catch_min,milr_tot_catch_min),
                        c(milr_under_catch_med,milr_within_catch_med,milr_over_catch_med,milr_tot_catch_med),
                        c(milr_under_catch_max,milr_within_catch_max,milr_over_catch_max,milr_tot_catch_max))
colnames(milr_catch_out)=c("impd","metric","susceptibility","25% reporting","50% reporting","75% reporting")
milr_catch_out

###############################################################################
## Exploitation rates, pages 554-556 in Fisheries Techniques 3rd edition
## Under
milr_under_harv_min=milr_under_harv/(milr_under_tagged*(1-milr_tl)*milr_rr_min)
milr_under_harv_med=milr_under_harv/(milr_under_tagged*(1-milr_tl)*milr_rr_med)
milr_under_harv_max=milr_under_harv/(milr_under_tagged*(1-milr_tl)*milr_rr_max)
milr_under_propharv=milr_under_harv/milr_under_ret

## Within
milr_within_harv_min=milr_within_harv/(milr_within_tagged*(1-milr_tl)*milr_rr_min)
milr_within_harv_med=milr_within_harv/(milr_within_tagged*(1-milr_tl)*milr_rr_med)
milr_within_harv_max=milr_within_harv/(milr_within_tagged*(1-milr_tl)*milr_rr_max)
milr_within_propharv=milr_within_harv/milr_within_ret

## Over
milr_over_harv_min=milr_over_harv/(milr_over_tagged*(1-milr_tl)*milr_rr_min)
milr_over_harv_med=milr_over_harv/(milr_over_tagged*(1-milr_tl)*milr_rr_med)
milr_over_harv_max=milr_over_harv/(milr_over_tagged*(1-milr_tl)*milr_rr_max)
milr_over_propharv=milr_over_harv/milr_over_ret

## Total susceptible
milr_tot_harv_min=nrow(milr_ret)/(milr_suscep*(1-milr_tl)*milr_rr_min)
milr_tot_harv_med=nrow(milr_ret)/(milr_suscep*(1-milr_tl)*milr_rr_med)
milr_tot_harv_max=nrow(milr_ret)/(milr_suscep*(1-milr_tl)*milr_rr_max)

## Annual exploitation
milr_ann_harv_min=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_min)
milr_ann_harv_med=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_med)
milr_ann_harv_max=nrow(milr_ret)/(nrow(milr_tag)*(1-milr_tl)*milr_rr_max)

milr_harv_out=bind_cols(c("milr","milr","milr","milr","milr"),
                        c("harv","harv","harv","harv","harv"),
                        c("under","within","over","suscep","annual"),
                        c(milr_under_harv_min,milr_within_harv_min,milr_over_harv_min,
                          milr_tot_harv_min,milr_ann_harv_min),
                        c(milr_under_harv_med,milr_within_harv_med,milr_over_harv_med,
                          milr_tot_harv_med,milr_ann_harv_med),
                        c(milr_under_harv_max,milr_within_harv_max,milr_over_harv_max,
                          milr_tot_harv_max,milr_ann_harv_max),
                        c(milr_under_propharv,milr_within_propharv,milr_over_propharv,NA,NA))
colnames(milr_harv_out)=c("impd","metric","susceptibility","25% reporting","50% reporting","75% reporting","prop_harv")
milr_harv_out

## Combine
milrout=bind_rows(milr_catch_out,milr_harv_out)

################################################################################
################################################################################
## El Dorado
eldr_ret=returndat%>%
  filter(impd=="ELDR")

eldr_harv=returndat%>%
  filter(impd=="ELDR" & hr=="Harvest")

eldr_tag=taggeddat%>%
  filter(impd=="ELDR")

## Identify number of fish returned in each size group
eldr_under_ret=nrow(subset(eldr_ret,nuwo=="under"))
eldr_within_ret=nrow(subset(eldr_ret,nuwo=="within"))
eldr_over_ret=nrow(subset(eldr_ret,nuwo=="over"))

## Identify number of fish harvested in each size group
eldr_under_harv=nrow(subset(eldr_ret,nuwo=="under" & hr=="Harvest"))
eldr_within_harv=nrow(subset(eldr_ret,nuwo=="within" & hr=="Harvest"))
eldr_over_harv=nrow(subset(eldr_ret,nuwo=="over" & hr=="Harvest"))

## Identify number of fish tagged in each size group
eldr_under_tagged=nrow(subset(eldr_tag,nuwo=="under"))
eldr_within_tagged=nrow(subset(eldr_tag,nuwo=="within"))
eldr_over_tagged=nrow(subset(eldr_tag,nuwo=="over"))

## Identify number of harvest-susceptible tagged fish
eldr_suscep=nrow(subset(eldr_tag,nuwo != "within"))

## State annual tag reporting rate and tag loss
eldr_rr_min=0.75
eldr_rr_med=0.50
eldr_rr_max=0.25
eldr_tl=0.30

###############################################################################
## Catch rates, pages 554-556 in Fisheries Techniques 3rd edition
## Under
eldr_under_catch_min=eldr_under_ret/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_under_catch_med=eldr_under_ret/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_under_catch_max=eldr_under_ret/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_max)

## Within
eldr_within_catch_min=eldr_within_ret/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_within_catch_med=eldr_within_ret/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_within_catch_max=eldr_within_ret/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_max)

## Over
eldr_over_catch_min=eldr_over_ret/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_over_catch_med=eldr_over_ret/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_over_catch_max=eldr_over_ret/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_max)

## Total
eldr_tot_catch_min=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_min)
eldr_tot_catch_med=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_med)
eldr_tot_catch_max=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_max)

eldr_catch_out=bind_cols(c("eldr","eldr","eldr","eldr"),
                         c("catch","catch","catch","catch"),
                         c("under","within","over","total"),
                         c(eldr_under_catch_min,eldr_within_catch_min,eldr_over_catch_min,eldr_tot_catch_min),
                         c(eldr_under_catch_med,eldr_within_catch_med,eldr_over_catch_med,eldr_tot_catch_med),
                         c(eldr_under_catch_max,eldr_within_catch_max,eldr_over_catch_max,eldr_tot_catch_max))
colnames(eldr_catch_out)=c("impd","metric","susceptibility","25% reporting","50% reporting","75% reporting")
eldr_catch_out

###############################################################################
## Exploitation rates, pages 554-556 in Fisheries Techniques 3rd edition
## Under
eldr_under_harv_min=eldr_under_harv/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_under_harv_med=eldr_under_harv/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_under_harv_max=eldr_under_harv/(eldr_under_tagged*(1-eldr_tl)*eldr_rr_max)
eldr_under_propharv=eldr_under_harv/eldr_under_ret

## Within
eldr_within_harv_min=eldr_within_harv/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_within_harv_med=eldr_within_harv/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_within_harv_max=eldr_within_harv/(eldr_within_tagged*(1-eldr_tl)*eldr_rr_max)
eldr_within_propharv=eldr_within_harv/eldr_within_ret

## Over
eldr_over_harv_min=eldr_over_harv/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_min)
eldr_over_harv_med=eldr_over_harv/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_med)
eldr_over_harv_max=eldr_over_harv/(eldr_over_tagged*(1-eldr_tl)*eldr_rr_max)
eldr_over_propharv=eldr_over_harv/eldr_over_ret

## Total susceptible
eldr_tot_harv_min=nrow(eldr_ret)/(eldr_suscep*(1-eldr_tl)*eldr_rr_min)
eldr_tot_harv_med=nrow(eldr_ret)/(eldr_suscep*(1-eldr_tl)*eldr_rr_med)
eldr_tot_harv_max=nrow(eldr_ret)/(eldr_suscep*(1-eldr_tl)*eldr_rr_max)

## Annual exploitation
eldr_ann_harv_min=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_min)
eldr_ann_harv_med=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_med)
eldr_ann_harv_max=nrow(eldr_ret)/(nrow(eldr_tag)*(1-eldr_tl)*eldr_rr_max)

eldr_harv_out=bind_cols(c("eldr","eldr","eldr","eldr","eldr"),
                        c("harv","harv","harv","harv","harv"),
                        c("under","within","over","suscep","annual"),
                        c(eldr_under_harv_min,eldr_within_harv_min,eldr_over_harv_min,
                          eldr_tot_harv_min,eldr_ann_harv_min),
                        c(eldr_under_harv_med,eldr_within_harv_med,eldr_over_harv_med,
                          eldr_tot_harv_med,eldr_ann_harv_med),
                        c(eldr_under_harv_max,eldr_within_harv_max,eldr_over_harv_max,
                          eldr_tot_harv_max,eldr_ann_harv_max),
                        c(eldr_under_propharv,eldr_within_propharv,eldr_over_propharv,NA,NA))
colnames(eldr_harv_out)=c("impd","metric","susceptibility","25% reporting","50% reporting","75% reporting","prop_harv")
eldr_harv_out

## Combine
eldrout=bind_rows(eldr_catch_out,eldr_harv_out)

################################################################################
################################################################################
## Tuttle Creek
tcrr_ret=returndat%>%
  filter(impd=="TCRR")

tcrr_harv=returndat%>%
  filter(impd=="TCRR" & hr=="Harvest")

tcrr_tag=taggeddat%>%
  filter(impd=="TCRR")

## Identify number of fish returned in each size group
tcrr_sq_ret=sum(tcrr_ret$SQ)
tcrr_qp_ret=sum(tcrr_ret$QP)
tcrr_pm_ret=sum(tcrr_ret$PM)
tcrr_m_ret=sum(tcrr_ret$M)

## Identify number of fish harvested in each size group
tcrr_sq_harv=sum(tcrr_harv$SQ)
tcrr_qp_harv=sum(tcrr_harv$QP)
tcrr_pm_harv=sum(tcrr_harv$PM)
tcrr_m_harv=sum(tcrr_harv$M)

## Identify number of fish tagged in each size group
tcrr_sq_tagged=sum(tcrr_tag$SQ)
tcrr_qp_tagged=sum(tcrr_tag$QP)
tcrr_pm_tagged=sum(tcrr_tag$PM)
tcrr_m_tagged=sum(tcrr_tag$M)

## Identify number of harvest-susceptible tagged fish
tcrr_suscep=nrow(tcrr_tag)

## State annual tag reporting rate and tag loss
tcrr_rr_min=0.75
tcrr_rr_med=0.50
tcrr_rr_max=0.25
tcrr_tl=0.30

###############################################################################
## Catch rates, pages 554-556 in Fisheries Techniques 3rd edition

## Stock-Quality length fish
tcrr_sq_catch_min=tcrr_sq_ret/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_sq_catch_med=tcrr_sq_ret/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_sq_catch_max=tcrr_sq_ret/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_max)

## Quality-Preferred length fish
tcrr_qp_catch_min=tcrr_qp_ret/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_qp_catch_med=tcrr_qp_ret/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_qp_catch_max=tcrr_qp_ret/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_max)

## Preferred-Memorable length fish
tcrr_pm_catch_min=tcrr_pm_ret/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_pm_catch_med=tcrr_pm_ret/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_pm_catch_max=tcrr_pm_ret/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_max)

## Memorable length fish
tcrr_m_catch_min=tcrr_m_ret/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_m_catch_med=tcrr_m_ret/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_m_catch_max=tcrr_m_ret/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_max)

tcrr_catch_out=bind_cols(c("tcrr","tcrr","tcrr","tcrr"),
                         c("catch","catch","catch","catch"),
                         c("S-Q","Q-P","P-M","M"),
                         c(tcrr_sq_catch_min,tcrr_qp_catch_min,tcrr_pm_catch_min,tcrr_m_catch_min),
                         c(tcrr_sq_catch_med,tcrr_qp_catch_med,tcrr_pm_catch_med,tcrr_m_catch_med),
                         c(tcrr_sq_catch_max,tcrr_qp_catch_max,tcrr_pm_catch_max,tcrr_m_catch_max))
colnames(tcrr_catch_out)=c("impd","metric","PSD","25% reporting","50% reporting","75% reporting")
tcrr_catch_out

###############################################################################
## Exploitation rates, pages 554-556 in Fisheries Techniques 3rd edition

## Stock-Quality length fish
tcrr_sq_harv_min=tcrr_sq_harv/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_sq_harv_med=tcrr_sq_harv/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_sq_harv_max=tcrr_sq_harv/(tcrr_sq_tagged*(1-tcrr_tl)*tcrr_rr_max)
tcrr_sq_propharv=tcrr_sq_harv/tcrr_sq_ret

## Quality-Preferred length fish
tcrr_qp_harv_min=tcrr_qp_harv/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_qp_harv_med=tcrr_qp_harv/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_qp_harv_max=tcrr_qp_harv/(tcrr_qp_tagged*(1-tcrr_tl)*tcrr_rr_max)
tcrr_qp_propharv=tcrr_qp_harv/tcrr_qp_ret

## Preferred-Memorable length fish
tcrr_pm_harv_min=tcrr_pm_harv/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_pm_harv_med=tcrr_pm_harv/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_pm_harv_max=tcrr_pm_harv/(tcrr_pm_tagged*(1-tcrr_tl)*tcrr_rr_max)
tcrr_pm_propharv=tcrr_pm_harv/tcrr_pm_ret

## Memorable length fish
tcrr_m_harv_min=tcrr_m_harv/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_min)
tcrr_m_harv_med=tcrr_m_harv/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_med)
tcrr_m_harv_max=tcrr_m_harv/(tcrr_m_tagged*(1-tcrr_tl)*tcrr_rr_max)
tcrr_m_propharv=tcrr_m_harv/tcrr_m_ret

## Total exploitation
tcrr_tot_harv_min=nrow(tcrr_harv)/(tcrr_suscep*(1-tcrr_tl)*tcrr_rr_min)
tcrr_tot_harv_med=nrow(tcrr_harv)/(tcrr_suscep*(1-tcrr_tl)*tcrr_rr_med)
tcrr_tot_harv_max=nrow(tcrr_harv)/(tcrr_suscep*(1-tcrr_tl)*tcrr_rr_max)

## Annual exploitation
tcrr_ann_harv_min=nrow(tcrr_harv)/(nrow(tcrr_tag)*(1-tcrr_tl)*tcrr_rr_min)
tcrr_ann_harv_med=nrow(tcrr_harv)/(nrow(tcrr_tag)*(1-tcrr_tl)*tcrr_rr_med)
tcrr_ann_harv_max=nrow(tcrr_harv)/(nrow(tcrr_tag)*(1-tcrr_tl)*tcrr_rr_max)

tcrr_harv_out=bind_cols(c("tcrr","tcrr","tcrr","tcrr","tcrr","tcrr"),
                         c("harv","harv","harv","harv","harv","harv"),
                         c("S-Q","Q-P","P-M","M","suscep","annual"),
                         c(tcrr_sq_harv_min,tcrr_qp_harv_min,tcrr_pm_harv_min,
                           tcrr_m_harv_min,tcrr_tot_harv_min,tcrr_ann_harv_min),
                         c(tcrr_sq_harv_med,tcrr_qp_harv_med,tcrr_pm_harv_med,
                           tcrr_m_harv_med,tcrr_tot_harv_med,tcrr_ann_harv_med),
                         c(tcrr_sq_harv_max,tcrr_qp_harv_max,tcrr_pm_harv_max,
                           tcrr_m_harv_max,tcrr_tot_harv_max,tcrr_ann_harv_max),
                         c(tcrr_sq_propharv,tcrr_qp_propharv,tcrr_pm_propharv,tcrr_m_propharv,NA,NA))
colnames(tcrr_harv_out)=c("impd","metric","PSD","25% reporting","50% reporting","75% reporting","prop_harv")
tcrr_harv_out

## Combine
tcrrout=bind_rows(tcrr_catch_out,tcrr_harv_out)

################################################################################
################################################################################
## Wolf Creek
wlfc_ret=returndat%>%
  filter(impd=="WLFC")

wlfc_harv=returndat%>%
  filter(impd=="WLFC" & hr=="Harvest")

wlfc_tag=taggeddat%>%
  filter(impd=="WLFC")

## Identify number of fish returned in each size group
wlfc_sq_ret=sum(wlfc_ret$SQ)
wlfc_qp_ret=sum(wlfc_ret$QP)
wlfc_pm_ret=sum(wlfc_ret$PM)
wlfc_m_ret=sum(wlfc_ret$M)

## Identify number of fish harvested in each size group
wlfc_sq_harv=sum(wlfc_harv$SQ)
wlfc_qp_harv=sum(wlfc_harv$QP)
wlfc_pm_harv=sum(wlfc_harv$PM)
wlfc_m_harv=sum(wlfc_harv$M)

## Identify number of fish tagged in each size group
wlfc_sq_tagged=sum(wlfc_tag$SQ)
wlfc_qp_tagged=sum(wlfc_tag$QP)
wlfc_pm_tagged=sum(wlfc_tag$PM)
wlfc_m_tagged=sum(wlfc_tag$M)

## Identify number of harvest-susceptible tagged fish
wlfc_suscep=nrow(wlfc_tag)

## State annual tag reporting rate and tag loss
wlfc_rr_min=0.75
wlfc_rr_med=0.50
wlfc_rr_max=0.25
wlfc_tl=0.30

###############################################################################
## Catch rates, pages 554-556 in Fisheries Techniques 3rd edition

## Stock-Quality length fish
wlfc_sq_catch_min=wlfc_sq_ret/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_sq_catch_med=wlfc_sq_ret/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_sq_catch_max=wlfc_sq_ret/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_max)

## Quality-Preferred length fish
wlfc_qp_catch_min=wlfc_qp_ret/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_qp_catch_med=wlfc_qp_ret/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_qp_catch_max=wlfc_qp_ret/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_max)

## Preferred-Memorable length fish
wlfc_pm_catch_min=wlfc_pm_ret/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_pm_catch_med=wlfc_pm_ret/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_pm_catch_max=wlfc_pm_ret/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_max)

## Memorable length fish
wlfc_m_catch_min=wlfc_m_ret/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_m_catch_med=wlfc_m_ret/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_m_catch_max=wlfc_m_ret/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_max)

wlfc_catch_out=bind_cols(c("wlfc","wlfc","wlfc","wlfc"),
                         c("catch","catch","catch","catch"),
                         c("S-Q","Q-P","P-M","M"),
                         c(wlfc_sq_catch_min,wlfc_qp_catch_min,wlfc_pm_catch_min,wlfc_m_catch_min),
                         c(wlfc_sq_catch_med,wlfc_qp_catch_med,wlfc_pm_catch_med,wlfc_m_catch_med),
                         c(wlfc_sq_catch_max,wlfc_qp_catch_max,wlfc_pm_catch_max,wlfc_m_catch_max))
colnames(wlfc_catch_out)=c("impd","metric","PSD","25% reporting","50% reporting","75% reporting")
wlfc_catch_out

###############################################################################
## Exploitation rates, pages 554-556 in Fisheries Techniques 3rd edition

## Stock-Quality length fish
wlfc_sq_harv_min=wlfc_sq_harv/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_sq_harv_med=wlfc_sq_harv/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_sq_harv_max=wlfc_sq_harv/(wlfc_sq_tagged*(1-wlfc_tl)*wlfc_rr_max)
wlfc_sq_propharv=wlfc_sq_harv/wlfc_sq_ret

## Quality-Preferred length fish
wlfc_qp_harv_min=wlfc_qp_harv/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_qp_harv_med=wlfc_qp_harv/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_qp_harv_max=wlfc_qp_harv/(wlfc_qp_tagged*(1-wlfc_tl)*wlfc_rr_max)
wlfc_qp_propharv=wlfc_qp_harv/wlfc_qp_ret

## Preferred-Memorable length fish
wlfc_pm_harv_min=wlfc_pm_harv/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_pm_harv_med=wlfc_pm_harv/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_pm_harv_max=wlfc_pm_harv/(wlfc_pm_tagged*(1-wlfc_tl)*wlfc_rr_max)
wlfc_pm_propharv=wlfc_pm_harv/wlfc_pm_ret

## Memorable length fish
wlfc_m_harv_min=wlfc_m_harv/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_min)
wlfc_m_harv_med=wlfc_m_harv/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_med)
wlfc_m_harv_max=wlfc_m_harv/(wlfc_m_tagged*(1-wlfc_tl)*wlfc_rr_max)
wlfc_m_propharv=wlfc_m_harv/wlfc_m_ret

## Total exploitation
wlfc_tot_harv_min=nrow(wlfc_harv)/(wlfc_suscep*(1-wlfc_tl)*wlfc_rr_min)
wlfc_tot_harv_med=nrow(wlfc_harv)/(wlfc_suscep*(1-wlfc_tl)*wlfc_rr_med)
wlfc_tot_harv_max=nrow(wlfc_harv)/(wlfc_suscep*(1-wlfc_tl)*wlfc_rr_max)

## Annual exploitation
wlfc_ann_harv_min=nrow(wlfc_harv)/(nrow(wlfc_tag)*(1-wlfc_tl)*wlfc_rr_min)
wlfc_ann_harv_med=nrow(wlfc_harv)/(nrow(wlfc_tag)*(1-wlfc_tl)*wlfc_rr_med)
wlfc_ann_harv_max=nrow(wlfc_harv)/(nrow(wlfc_tag)*(1-wlfc_tl)*wlfc_rr_max)

wlfc_harv_out=bind_cols(c("wlfc","wlfc","wlfc","wlfc","wlfc","wlfc"),
                        c("harv","harv","harv","harv","harv","harv"),
                        c("S-Q","Q-P","P-M","M","suscep","annual"),
                        c(wlfc_sq_harv_min,wlfc_qp_harv_min,wlfc_pm_harv_min,
                          wlfc_m_harv_min,wlfc_tot_harv_min,wlfc_ann_harv_min),
                        c(wlfc_sq_harv_med,wlfc_qp_harv_med,wlfc_pm_harv_med,
                          wlfc_m_harv_med,wlfc_tot_harv_med,wlfc_ann_harv_med),
                        c(wlfc_sq_harv_max,wlfc_qp_harv_max,wlfc_pm_harv_max,
                          wlfc_m_harv_max,wlfc_tot_harv_max,wlfc_ann_harv_max),
                        c(wlfc_sq_propharv,wlfc_qp_propharv,wlfc_pm_propharv,wlfc_m_propharv,NA,NA))
colnames(wlfc_harv_out)=c("impd","metric","PSD","25% reporting","50% reporting","75% reporting","prop_harv")
wlfc_harv_out

## Combine
wlfcout=bind_rows(wlfc_catch_out,wlfc_harv_out)

################################################################################
################################################################################
## Plots

## Milford
## Create data to show annual exploitation
milr_annotate=filter(milrout,susceptibility=="annual")

## Get data formatted correctly
milr_plotdat=milrout%>%
  filter(susceptibility %in% c("under","within","over"))%>%
  mutate(susceptibility=factor(susceptibility,levels=c("under","within","over")))

## Create plot
milrplot=ggplot(milr_plotdat)+
  annotate("rect",
           xmin=milr_annotate$`25% reporting`,
           xmax=milr_annotate$`75% reporting`,
           ymin=0,ymax=3.2,
           fill="gray",alpha=0.7)+
  geom_pointrange(aes(y=fct_rev(susceptibility),x=`50% reporting`,xmin=`75% reporting`,xmax=`25% reporting`,
                      color=metric),position=position_dodge(width=-0.3),size=1.5)+
  geom_point(aes(y=fct_rev(susceptibility),x=prop_harv),shape="|",color="black",size=8)+
  scale_color_manual(values=c("black","gray"),
                     labels=c("Catch","Harvest"))+
  scale_x_continuous(breaks=seq(0,1,0.1),
                     name="")+
  scale_y_discrete(labels=c("Over","Within","Under"),
                   name="")+
  coord_cartesian(xlim=c(-0.02,1.06),ylim=c(0.5,3.5),expand=F)+
  annotate("text",label="Milford",x=0,y=3.47,hjust=0,vjust=1,size=6)+
  pubtheme

#####################################
## El Dorado
## Create data to show annual exploitation
eldr_annotate=filter(eldrout,susceptibility=="annual")

## Get data formatted correctly
eldr_plotdat=eldrout%>%
  filter(susceptibility %in% c("under","within","over"))%>%
  mutate(susceptibility=factor(susceptibility,levels=c("under","within","over")))

## Create plot
eldrplot=ggplot(eldr_plotdat)+
  annotate("rect",
           xmin=eldr_annotate$`25% reporting`,
           xmax=eldr_annotate$`75% reporting`,
           ymin=0,ymax=3.2,
           fill="gray",alpha=0.7)+
  geom_pointrange(aes(y=fct_rev(susceptibility),x=`50% reporting`,xmin=`75% reporting`,xmax=`25% reporting`,
                      color=metric),position=position_dodge(width=-0.3),size=1.5)+
  geom_point(aes(y=fct_rev(susceptibility),x=prop_harv),shape="|",color="black",size=8)+
  scale_color_manual(values=c("black","gray"),
                     labels=c("Catch","Harvest"))+
  scale_x_continuous(breaks=seq(0,1,0.1),
                     name="")+
  scale_y_discrete(labels=c("Over","Within","Under"),
                   name="")+

  coord_cartesian(xlim=c(-0.02,1.06),ylim=c(0.5,3.5),expand=F)+
  annotate("text",label="El Dorado",x=0,y=3.47,hjust=0,vjust=1,size=6)+
  pubtheme

#####################################
## Tuttle Creek
## Create data to show annual exploitation
tcrr_annotate=filter(tcrrout,PSD=="annual")

## Get data formatted correctly
tcrr_plotdat=tcrrout%>%
  filter(PSD %in% c("S-Q","Q-P","P-M","M"))%>%
  mutate(PSD=factor(PSD,levels=c("S-Q","Q-P","P-M","M")),
         `75% reporting`=case_when(`75% reporting` > 1 ~ 1,
                                   TRUE ~ `75% reporting`))
## Create plot
tcrrplot=ggplot(tcrr_plotdat)+
  annotate("rect",
           xmin=tcrr_annotate$`25% reporting`,
           xmax=tcrr_annotate$`75% reporting`,
           ymin=-0.02,ymax=4.2,
           fill="gray",alpha=0.7)+
  geom_pointrange(aes(y=fct_rev(PSD),x=`50% reporting`,xmin=`75% reporting`,xmax=`25% reporting`,
                      color=metric),position=position_dodge(width=-0.3),size=1.5)+
  geom_point(aes(y=fct_rev(PSD),x=prop_harv),shape="|",color="black",size=8)+
  scale_color_manual(values=c("black","gray"),
                     labels=c("Catch","Harvest"))+
  scale_x_continuous(breaks=seq(0,1,0.1),
                     name="Proportion of tagged fish reported by anglers")+
  scale_y_discrete(labels=c("M+","P-M","Q-P","S-Q"),
                   name="")+
  coord_cartesian(xlim=c(-0.02,1.06),ylim=c(0.5,4.5),expand=F)+
  annotate("text",label="Tuttle Creek",x=0,y=4.48,hjust=0,vjust=1,size=6)+
  pubtheme+
  theme(axis.title.x=element_text(hjust=-1.5))

#####################################
## Wolf Creek
## Create data to show annual exploitation
wlfc_annotate=filter(wlfcout,PSD=="annual")

## Get data formatted correctly
wlfc_plotdat=wlfcout%>%
  filter(PSD %in% c("S-Q","Q-P","P-M","M"))%>%
  mutate(PSD=factor(PSD,levels=c("S-Q","Q-P","P-M","M")),
         `75% reporting`=case_when(`75% reporting` > 1 ~ 1,
                                   TRUE ~ `75% reporting`))
## Create plot
wlfcplot=ggplot(wlfc_plotdat)+
  annotate("rect",
           xmin=wlfc_annotate$`25% reporting`,
           xmax=wlfc_annotate$`75% reporting`,
           ymin=-0.02,ymax=4.2,
           fill="gray",alpha=0.7)+
  geom_pointrange(aes(y=fct_rev(PSD),x=`50% reporting`,xmin=`75% reporting`,xmax=`25% reporting`,
                      color=metric),position=position_dodge(width=-0.3),size=1.5)+
  geom_point(aes(y=fct_rev(PSD),x=prop_harv),shape="|",color="black",size=8)+
  scale_color_manual(values=c("black","gray"),
                     labels=c("Catch","Harvest"))+
  scale_x_continuous(breaks=seq(0,1,0.1),
                     name="")+
  scale_y_discrete(labels=c("M+","P-M","Q-P","S-Q"),
                   name="")+
  coord_cartesian(xlim=c(-0.02,1.06),ylim=c(0.5,4.5),expand=F)+
  annotate("text",label="Wolf Creek",x=0,y=4.48,hjust=0,vjust=1,size=6)+
  pubtheme

################################################################################
## Combine plots
out=(milrplot|eldrplot)/(tcrrplot|wlfcplot)
ggsave(plot=out,"exploitation.png",width=10,height=6.7,bg="white")